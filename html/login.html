<!DOCTYPE html>
<html lang="en">

<head>
  <title>Tartarus - Login</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1">
  <meta name="description" content="Tartarus is a game developer and publisher">
  <meta name="keywords" content="cyber-amr, tartarus, spirit, games, studio">
  <meta property="og:image" content="https://amr-dev.info/studio.png">
  <link rel="icon" type="image/x-icon" href="icon.ico" sizes="any">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <script>let FIX_FF_FOUC;</script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MWHPXGX9FN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-MWHPXGX9FN');
  </script>
  <style>
    body {
      background-color: #1a1b26;
      color: #a9b3d6;
      font-family: 'Courier New', 'Lucida Console', monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      line-height: 1.6;
      padding: 1rem;
    }

    .login-container {
      background-color: #24283b;
      padding: 2rem;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 600px;
    }

    .prompt {
      color: #6faaf6;
      margin-bottom: 2rem;
      font-size: 1.2em;
    }

    .input-group {
      margin-bottom: 1.5rem;
      position: relative;
    }

    label {
      display: block;
      color: #6faaf6;
      margin-bottom: 0.5rem;
    }

    input {
      width: 100%;
      padding: 0.5rem;
      background-color: #1a1b26;
      border: 1px solid #393f69;
      color: #a9b3d6;
      font-family: 'Courier New', 'Lucida Console', monospace;
      box-sizing: border-box;
    }

    input:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    input:focus {
      outline: none;
      border-color: #6faaf6;
    }

    .status {
      position: absolute;
      right: 0;
      top: 0;
      color: #6faaf6;
      font-size: 0.9em;
      margin-top: 0.5rem;
    }

    .error {
      color: #f6666f;
    }

    .success {
      color: #9ece6e;
    }

    a {
      color: #6faaf6;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    button {
      width: 100%;
      padding: 0.5rem;
      background-color: #6faaf6;
      color: #1a1b26;
      border: none;
      cursor: pointer;
      font-family: 'Courier New', 'Lucida Console', monospace;
      font-weight: bold;
      margin-top: 1rem;
    }

    button:focus,
    button:hover {
      background-color: #3c66c3;
    }

    button:disabled {
      background-color: #393f69;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .cursor {
      animation: blink 0.5s step-start 0s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    .forgot-password {
      text-align: right;
      margin-top: 0.5rem;
      font-size: 0.9em;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin: 1rem 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-left: 1rem;
      cursor: pointer;
    }

    .checkbox-group label {
      display: inline;
      margin: 0;
      cursor: pointer;
    }

    input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border: 1px solid #393f69;
      background-color: #1a1b26;
      border-radius: 2px;
      position: relative;
    }

    input[type="checkbox"]:checked {
      background-color: #6faaf6;
    }

    input[type="checkbox"]:checked::after {
      content: "✓";
      position: absolute;
      color: #1a1b26;
      font-size: 12px;
      left: 4px;
      top: -1px;
    }
  </style>
</head>

<body>
  <div class="login-container">
    <div class="prompt">$ ./login --enter-tartarus</div>
    <form id="loginForm" action="/login" method="POST">
      <div class="input-group">
        <label id="identifierLabel" for="identifier">username:~$</label>
        <input type="username" id="identifier" name="identifier" required>
        <div class="status" id="identifierStatus">Enter username or email</div>
      </div>
      <div class="input-group">
        <label for="password">password:~$</label>
        <input type="password" id="password" name="password" required>
        <div class="status" id="passwordStatus"></div>
      </div>
      <div class="checkbox-group">
        <label for="keepMeLoggedIn">keep_me_logged_in:~$</label>
        <input type="checkbox" id="keepMeLoggedIn" name="keepMeLoggedIn" checked>
      </div>
      <div class="forgot-password">
        <a href="/recovery">Forgot password?</a>
      </div>
      <div>New to the space? <a href="/signup">sign up</a> instead</div>
      <button type="submit" id="submitButton" disabled>LOGIN <span class="cursor">█</span></button>
    </form>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search)
    const emailParam = params.get('email')
    const usernameParam = params.get('username')

    const submitButton = document.getElementById('submitButton')
    const identifier = document.getElementById('identifier')
    const password = document.getElementById('password')
    const passwordStatus = document.getElementById('passwordStatus')

    const valid = {
      username: false,
      email: false,
      pass: false
    }

    if (emailParam && /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(emailParam)) {
      document.getElementById('identifierLabel').textContent = 'email:~$'
      const link = document.createElement('a')
      link.textContent = 'another account?'
      link.href = '/login'
      document.getElementById('identifierStatus').textContent = ''
      document.getElementById('identifierStatus').appendChild(link)

      identifier.value = emailParam
      identifier.disabled = true
      valid.email = true
      valid.username = false
      password.focus()
    } else if (usernameParam && /^[A-Za-z0-9_]{1,16}$/.test(usernameParam)) {
      const link = document.createElement('a')
      link.textContent = 'another account?'
      link.href = '/login'
      document.getElementById('identifierStatus').textContent = ''
      document.getElementById('identifierStatus').appendChild(link)

      identifier.value = usernameParam
      identifier.disabled = true
      valid.username = true
      valid.email = false
      password.focus()
    } else identifier.focus()

    setInterval(() => {
      valid.username = /^[A-Za-z0-9_]{1,16}$/.test(identifier.value)
      valid.email = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(identifier.value)
      valid.pass = password.value.length >= 8
      submitButton.disabled = (!valid.username && !valid.email) || !valid.pass
    }, 50)

    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault()

      const formData = new FormData(e.target)

      const data = {
        username: valid.username ? formData.get('identifier') ?? usernameParam : undefined,
        email: valid.email ? formData.get('identifier') ?? emailParam : undefined,
        password: formData.get('password'),
        keepMeLoggedIn: formData.get('keepMeLoggedIn') === 'on'
      }
      fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(async res => {
          if (res.ok) {
            window.location.href = '/'
          } else {
            throw new Error(`(${res.status}) ${(await res.json().catch(() => { }))?.error ?? "Login failed"}`)
          }
        })
        .catch(err => {
          passwordStatus.textContent = "check your credentials"
          passwordStatus.className = 'status error'
          password.value = ""
          identifier.focus()
          valid.pass = false
        })
    })
  </script>
</body>

</html>
